#!/usr/bin/env bash

__tf_ps1 () {
    local workspace=""
    local print_format=${1:-(%s)}

    if [[ -z ${TF_WORKSPACE+x} ]]; then
        if [[ -f .terraform/environment ]]; then
            workspace=`cat .terraform/environment`
        else
            workspace=""
        fi
    else
        workspace=${TF_WORKSPACE}
    fi

    if [[ $workspace != "" ]]; then
        printf -- "$print_format" "$workspace"
    fi

    unset workspace print_format
    return 0
}

__pretty_prompt_ps1 () {
    # reset, bold, colors
    local reset=$(tput sgr0)
    local bold=$(tput bold)
    local dim=$(tput dim)
    local black=$(tput setaf 0)
    local red=$(tput setaf 1)
    local green=$(tput setaf 2)
    local yellow=$(tput setaf 3)
    local blue=$(tput setaf 4)
    local magenta=$(tput setaf 5)
    local cyan=$(tput setaf 6)
    local white=$(tput setaf 7)
    local bgblack=$(tput setab 0)
    local bgred=$(tput setab 1)
    local bggreen=$(tput setab 2)
    local bgyellow=$(tput setab 3)
    local bgblue=$(tput setab 4)
    local bgmagenta=$(tput setab 5)
    local bgcyan=$(tput setab 6)
    local bgwhite=$(tput setab 7)

    # â—¤
    local cap=$'\u25e4'
    # terraform workspace prompt
    local tfprmpt="$(__tf_ps1 "\[$bgblue\]\[$black\] %s \[$reset\]\[$blue\]${cap}")"
    # git prompt
    local gitprmpt="$(__git_ps1 "\[$bgmagenta\]\[$black\] %s \[$bgblue\]\[$magenta\]${cap}")"
    # working dir
    local wdir="\[$black\]\[$bgcyan\] \w "

    # add cap when empty
    if [ "$gitprmpt" != "" ]; then
        wdir+="\[$cyan\]\[$bgmagenta\]${cap}\[$reset\]"
    else
        wdir+="\[$bgmagenta\]\[$cyan\]${cap}\[$reset\]"
        gitprmpt="\[$bgmagenta\]\[$magenta\]\[$bgblue\]${cap}"
    fi

    # add cap when empty
    if [ "$tfprmpt" = "" ]; then
        tfprmpt="\[$reset\]\[$blue\]${cap}"
    fi

    PS1="${wdir}${gitprmpt}${tfprmpt}\n\[$reset\]"
}