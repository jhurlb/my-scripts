#!/usr/bin/env bash


clean_boohma_dump() {
  perl -pe 's/\sDEFINER=`[^`]+`@`[^`]+`//' < boohma.sql > boohma_no_definers.sql
}

proj() {
    cd "$HOME/Projects/src/$1" || exit
}

doc() {
    cd "$HOME/Projects/docker/$1" || exit
}

g2() {
  cd "$HOME/Projects/src/go/src/github.com/Billups/$1" || echo "Could not find go project $1"
}

serve() {
    for command in "$@"
    do
        case $command in
            hb )
                (g2 harebrane && \
                go install github.com/Billups/harebrane/cmd/harebraneserver && \
                harebraneserver ./)
                ;;
            geo )
                (g2 geo && \
                go install github.com/Billups/geo/cmd/geoserver && \
                geoserver ./)
                ;;
            gogrid )
                (g2 gogrid && \
                go install github.com/Billups/gogrid/cmd/gogrid && \
                gogrid ./)
                ;;
            demos )
                (proj demos && \
                pyenv exec python run.py)
                ;;
            tiles )
                (proj tilestache && \
                dc up -d)
                ;;
            redis )
                (doc redis || exit && \
                dc up -d )
                ;;
            mariadb )
                (doc mariadb || exit && \
                dc up -d)
                ;;
            keycloak )
                (doc keycloak || exit && \
                dc up -d )
                ;;
            *)
                echo "usage: serve [hb, geo, gogrid, demos, tiles, redis, mariadb, keycloak]"
                ;;
        esac
    done
}

goct() {
  go test -covermode=count -coverprofile=profile.tmp
  go tool cover -html profile.tmp
  rm profile.tmp
}

vg() {
    command=$1
    case $command in
        -p|provision )
            vagrant provision
            ;;
        -s|ssh )
            vagrant ssh
            ;;
        -d|deploy )
            export DEPLOY_USER=ci
            export DEPLOY_SERVER=192.168.0.51
            export DEPLOY_BRANCH=${2:-"develop"}
            export DEPLOY_VHOST=${3:-"boohma.com"}
            rbenv exec cap ci deploy
            ;;
        *)
            echo "usage: vg [-p|provison, -s|ssh, -d|deploy [branch] [vhost]]"
            ;;
    esac
}
